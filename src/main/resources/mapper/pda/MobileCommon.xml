<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pda.api.mapper.primary.MobileCommonMapper">

    <select id="checkUser" resultType="com.pda.api.dto.UserResDto">
        select sd.user_name userName,
               sd.name,sd.dept_code deptCode,
               dd.dept_name deptName,
               sd.job
        from
        (select user_name,name,dept_code,job from staff_dict where user_name = #{account}) sd
        inner join dept_dict dd on sd.dept_code = dd.dept_code
    </select>

    <select id="selectSubjectCheck" resultType="com.pda.api.dto.SpecimenCheckResDto">
        select a.patient_id as patientId,
               a.visit_id as visitId,
               a.test_no as testNo,
               LISTAGG(a.item_name, ',') WITHIN GROUP(ORDER BY a.item_name) AS subject,
               a.specimen as specimen,
               a.Requested_Date_Time as requestedDateTime,
               nvl((select t.dept_name from dept_dict t where t.dept_code = a.Performed_By),a.Performed_By) as performedBy
        from (
            select a.patient_id,
       a.visit_id,
       a.test_no,
       b.item_name,
       b.item_no,
       a.Requested_Date_Time as Requested_Date_Time,
      nvl( (select t.dept_name from dept_dict t where t.dept_code = a.Ordering_Dept),a.Ordering_Dept) as applyDept,
       nvl((SELECT TT.NAME FROM STAFF_DICT TT WHERE TT.USER_NAME= a.Ordering_Provider),Ordering_Provider) as applyDoctor,
       nvl((select t.dept_name from dept_dict t where t.dept_code = a.Performed_By),a.Performed_By) as Performed_By,
       A.SPECIMEN AS specimen,
       a.subject,
       a.spcm_received_date_time,
       a.Spcm_Sample_Date_Time,
        nvl((SELECT TT.NAME FROM STAFF_DICT TT WHERE TT.USER_NAME= a.transcriptionist),a.transcriptionist)   aS transcriptionist,
        a.result_status,
       (select y.exam_result_status_name
          from EXAM_RESULT_STATUS_DICT y
         where y.exam_result_status_code = a.result_status) as result_status, a.billing_indicator
    from LAB_TEST_MASTER a ,LAB_TEST_ITEMS b
    where a.patient_id = #{patientId} and a.visit_id = #{visitId}
    and a.test_no = b.Test_No
        ) a
    group by a.patient_id,
               a.visit_id,
               a.test_no,
               a.specimen,
               a.requested_Date_Time,
                a.performed_By
    </select>

    <select id="selectBlood" resultType="com.pda.api.domain.entity.BloodInfo">
        select a.patient_id as patientId, a.visit_id as visitId,
               c.blood_id as bloodId,
               b.trans_capacity ||'/'|| b.unit as transCapacity,
               a.blood_diagnose  as bloodDiagnose,
               a.sxmd as sxmd,
               a.sxmd1 as sxmd1,
               a.apply_date as applyDate,
               a.is_fanying as isFanying,
               a.is_renchen as isRenshen,
               c.audit_man as auditMan,
               c.match_operator as matchOperator,
               c.match_date as matchDate,
               a.js_operator as jsOperator,
               a.jssj as jssj,
               a.sqabo as sqabo ,
              (select d.blood_type_name  from BLOOD_COMPONENT d
                         where d.blood_type = b.blood_type) as bloodTypeName
        from BLOOD_APPLY a,
             BLOOD_CAPACITY b, blood_match c
        where a.apply_num = b.apply_num
        and b.apply_num = c.apply_num
        and b.match_sub_num = c.match_sub_num
        and a.patient_id = #{patientId} and a.visit_id = #{visitId}
    </select>
</mapper>
